<ion-header>
  <ion-toolbar color="primary">
    <ion-title class="ion-text-center">
      üìù Historial de Apuntes - M√≥dulo N¬∞ {{ moduloId }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Informaci√≥n del m√≥dulo -->
  <ion-card color="light" class="modulo-info-card" *ngIf="modulo">
    <ion-card-header>
      <ion-card-title>{{ modulo.nombre }}</ion-card-title>
      <ion-card-subtitle>{{ modulo.ubicacion }} - Versi√≥n {{ modulo.version }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="valores-actuales">
        <div class="valor-item up">
          <ion-chip color="success">
            <ion-label>UP: {{ modulo.up }}</ion-label>
          </ion-chip>
        </div>
        <div class="valor-item down">
          <ion-chip color="warning">
            <ion-label>DOWN: {{ modulo.down }}</ion-label>
          </ion-chip>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- √öltimo apunte destacado -->
  <ion-card color="light" class="ultimo-apunte" *ngIf="apuntes && apuntes.length > 0">
    <ion-card-header>
      <ion-card-title>üìå √öltimo Apunte</ion-card-title>
      <ion-card-subtitle>{{ apuntes[0].fecha | date: 'dd/MM/yyyy HH:mm:ss' }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="valores-destacados">
        <div class="valor-up">
          <span class="label">UP:</span>
          <span class="valor">{{ apuntes[0].up }}</span>
        </div>
        <div class="valor-down">
          <span class="label">DOWN:</span>
          <span class="valor">{{ apuntes[0].down }}</span>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Filtros de fecha -->
  <ion-card color="light" class="filtros-card">
    <ion-card-header>
      <ion-card-title>üóìÔ∏è Filtrar por fecha</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-row>
        <ion-col size="6">
          <ion-item>
            <ion-label position="stacked">Desde:</ion-label>
            <ion-datetime 
              [(ngModel)]="fechaDesde" 
              presentation="date"
              (ionChange)="filtrarPorFechas()"
              locale="es-ES">
            </ion-datetime>
          </ion-item>
        </ion-col>
        <ion-col size="6">
          <ion-item>
            <ion-label position="stacked">Hasta:</ion-label>
            <ion-datetime 
              [(ngModel)]="fechaHasta" 
              presentation="date"
              (ionChange)="filtrarPorFechas()"
              locale="es-ES">
            </ion-datetime>
          </ion-item>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col size="12">
          <ion-button 
            expand="block" 
            fill="outline" 
            color="medium" 
            (click)="limpiarFiltros()">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Limpiar filtros
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-card-content>
  </ion-card>

  <!-- Lista de apuntes ordenados por fecha -->
  <ion-card color="light" class="historial-card" *ngIf="apuntesFiltrados && apuntesFiltrados.length > 0">
    <ion-card-header>
      <ion-card-title>
        üìã Historial de Apuntes
        <ion-chip color="primary">
          <ion-label>{{ apuntesFiltrados.length }} registros</ion-label>
        </ion-chip>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Agrupaci√≥n por fecha -->
      <div *ngFor="let grupo of apuntesAgrupados" class="grupo-fecha">
        <div class="fecha-separador">
          <h3>{{ grupo.fecha }}</h3>
          <ion-chip color="secondary">
            <ion-label>{{ grupo.apuntes.length }} apuntes</ion-label>
          </ion-chip>
        </div>
        
        <ion-list lines="full">
          <ion-item 
            *ngFor="let apunte of grupo.apuntes; let i = index; trackBy: trackByApunte" 
            class="item-apunte"
            button
            (click)="verDetalleApunte(apunte)">
            
            <div slot="start" class="numero-apunte">
              <ion-chip color="tertiary">
                <ion-label>#{{ grupo.apuntes.length - i }}</ion-label>
              </ion-chip>
            </div>
            
            <ion-label>
              <h2>{{ apunte.fecha | date: 'HH:mm:ss' }}</h2>
              <div class="valores-inline">
                <div class="valor-up-inline">
                  <span class="label">UP:</span>
                  <span class="valor" [class.cambio]="i < grupo.apuntes.length - 1 && apunte.up !== grupo.apuntes[i + 1].up">
                    {{ apunte.up }}
                  </span>
                </div>
                <div class="valor-down-inline">
                  <span class="label">DOWN:</span>
                  <span class="valor" [class.cambio]="i < grupo.apuntes.length - 1 && apunte.down !== grupo.apuntes[i + 1].down">
                    {{ apunte.down }}
                  </span>
                </div>
              </div>
            </ion-label>
            
            <div slot="end" class="cambios-indicador">
              <ion-icon 
                name="trending-up" 
                color="success" 
                *ngIf="i < grupo.apuntes.length - 1 && (apunte.up > grupo.apuntes[i + 1].up || apunte.down > grupo.apuntes[i + 1].down)">
              </ion-icon>
              <ion-icon 
                name="trending-down" 
                color="danger" 
                *ngIf="i < grupo.apuntes.length - 1 && (apunte.up < grupo.apuntes[i + 1].up || apunte.down < grupo.apuntes[i + 1].down)">
              </ion-icon>
              <ion-icon 
                name="remove" 
                color="medium" 
                *ngIf="i < grupo.apuntes.length - 1 && apunte.up === grupo.apuntes[i + 1].up && apunte.down === grupo.apuntes[i + 1].down">
              </ion-icon>
            </div>
          </ion-item>
        </ion-list>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Estad√≠sticas resumen -->
  <ion-card color="light" class="estadisticas-card" *ngIf="apuntesFiltrados && apuntesFiltrados.length > 0">
    <ion-card-header>
      <ion-card-title>üìä Estad√≠sticas del per√≠odo</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-row>
        <ion-col size="6">
          <div class="estadistica-item">
            <h4>UP</h4>
            <p>M√°ximo: <strong>{{ estadisticas.upMax }}</strong></p>
            <p>M√≠nimo: <strong>{{ estadisticas.upMin }}</strong></p>
            <p>Promedio: <strong>{{ estadisticas.upPromedio }}</strong></p>
          </div>
        </ion-col>
        <ion-col size="6">
          <div class="estadistica-item">
            <h4>DOWN</h4>
            <p>M√°ximo: <strong>{{ estadisticas.downMax }}</strong></p>
            <p>M√≠nimo: <strong>{{ estadisticas.downMin }}</strong></p>
            <p>Promedio: <strong>{{ estadisticas.downPromedio }}</strong></p>
          </div>
        </ion-col>
      </ion-row>
    </ion-card-content>
  </ion-card>

  <!-- Si no hay apuntes -->
  <ion-card color="light" *ngIf="!apuntes || apuntes.length === 0">
    <ion-card-content>
      <div class="no-data">
        <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
        <p>No hay apuntes disponibles para este m√≥dulo</p>
        <ion-button fill="outline" color="primary" (click)="cargarApuntes()">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Actualizar
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botones de navegaci√≥n -->
  <div class="botones-navegacion">
    <ion-button 
      expand="block" 
      fill="outline" 
      color="medium" 
      (click)="volverAlModulo()"
      class="boton-navegacion">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      Volver al M√≥dulo
    </ion-button>
    
    <ion-button 
      expand="block" 
      color="primary" 
      (click)="volverAlHome()"
      class="boton-navegacion">
      <ion-icon name="home" slot="start"></ion-icon>
      Ir al Home
    </ion-button>
  </div>
</ion-content>