<div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow overflow-hidden">
    <!-- Header del Card -->
    <div class="p-4 {% if modulo.estado == 'online' %}bg-green-50{% elif modulo.estado == 'warning' %}bg-yellow-50{% else %}bg-red-50{% endif %}">
        <div class="flex items-center justify-between">
            <h3 class="font-bold text-gray-800">{{ modulo.nombre }}</h3>
            <div class="flex items-center space-x-1">
                <span class="status-indicator {% if modulo.estado == 'online' %}online{% elif modulo.estado == 'warning' %}warning{% else %}offline{% endif %}"></span>
                
                <span class="text-xs font-semibold {% if modulo.estado == 'online' %}text-green-700{% elif modulo.estado == 'warning' %}text-yellow-700{% else %}text-red-700{% endif %}">
                    {{ modulo.estado|upper }}
                </span>
            </div>
        </div>
        <p class="text-sm text-gray-600 mt-1">
            <i class="fas fa-location-dot mr-1"></i>{{ modulo.ubicacion }}
            <span class="ml-2 text-xs bg-white px-2 py-1 rounded">v{{ modulo.version }}</span>
        </p>
    </div>
    
    <!-- Body del Card -->
    <div class="p-4 space-y-3">
        <!-- Mediciones -->
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">
                <i class="fas fa-temperature-high text-red-500 mr-2"></i>Temperatura
            </span>
            <span class="font-semibold text-gray-800">{{ modulo.temperatura|floatformat:1 }}°C</span>
        </div>
        
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">
                <i class="fas fa-gauge text-blue-500 mr-2"></i>Presión
            </span>
            <span class="font-semibold text-gray-800">{{ modulo.presion|floatformat:1 }} bar</span>
        </div>
        
        <!-- Valores UP y DOWN -->
        <div class="flex items-center justify-between pt-2 border-t border-gray-200">
            <div class="text-center flex-1">
                <p class="text-xs text-gray-500">UP</p>
                <p class="font-bold {% if modulo.estado_up == 'correcto' %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ modulo.up }}
                </p>
                {% if modulo.estado_up == 'mismatch' %}
                    <i class="fas fa-exclamation-triangle text-red-500 text-xs"></i>
                {% endif %}
            </div>
            <div class="border-l border-gray-200 h-8"></div>
            <div class="text-center flex-1">
                <p class="text-xs text-gray-500">DOWN</p>
                <p class="font-bold {% if modulo.estado_down == 'correcto' %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ modulo.down }}
                </p>
                {% if modulo.estado_down == 'mismatch' %}
                    <i class="fas fa-exclamation-triangle text-red-500 text-xs"></i>
                {% endif %}
            </div>
        </div>

        <!-- ===== NUEVA SECCIÓN: Control con Información Técnica ===== -->
        <div class="pt-3 border-t border-gray-200">
            <!-- Toggle de Encendido/Apagado con Info -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700">Más información técnica:</span>
                <button 
                    type="button"
                    onclick="toggleInfoTecnica{{ modulo.modulo_id }}()"
                    class="text-gray-500 hover:text-blue-600 transition-colors"
                    title="Ver información técnica">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
                </div>
            </div>

            <div class="reinicio-container-{{ modulo.modulo_id }}">
                <button 
                    type="button"
                    id="btn-reinicio-{{ modulo.modulo_id }}"
                    class="w-full py-3.5 px-5 text-white font-bold text-sm uppercase tracking-wide rounded-2xl transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-60 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 active:translate-y-0"
                    style="background-color: #a8c7fa;"
                    onmouseover="this.style.backgroundColor='#8bb4f7'"
                    onmouseout="if(!this.disabled) this.style.backgroundColor='#a8c7fa'"
                    onclick="reiniciarModulo({{ modulo.modulo_id }})"
                >
                    <i class="fas fa-redo-alt text-base" id="icono-reinicio-{{ modulo.modulo_id }}"></i>
                    <span id="texto-reinicio-{{ modulo.modulo_id }}">Reiniciar Módulo</span>
                </button>
                
                <!-- Mensaje de espera -->
                <div id="mensaje-cooldown-{{ modulo.modulo_id }}" class="hidden mt-3 text-center">
                    <div class="inline-flex items-center space-x-2 text-xs font-semibold px-4 py-2.5 rounded-full shadow-sm" style="background-color: #e8f0fe; color: #5a7db8;">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Podrás reiniciar en <span id="tiempo-restante-{{ modulo.modulo_id }}" class="font-bold" style="color: #4a6ba5;">30</span>s</span>
                    </div>
                </div>
            </div>

            <!-- Panel de información técnica (colapsable) -->
            <div id="info-tecnica-{{ modulo.modulo_id }}" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                <div class="text-xs text-gray-600">
                    <div class="flex items-center justify-between py-1">
                        <span class="flex items-center">
                            <i class="fas fa-microchip text-purple-500 mr-2 w-4"></i>
                            <span class="font-medium">Firmware:</span>
                        </span>
                        <span class="font-mono text-gray-800">{{ modulo.version_firmware|default:"N/A" }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between py-1">
                        <span class="flex items-center">
                            <i class="fas fa-network-wired text-blue-500 mr-2 w-4"></i>
                            <span class="font-medium">IP:</span>
                        </span>
                        <span class="font-mono text-gray-800">{{ modulo.direccion_ip|default:"N/A" }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between py-1">
                        <span class="flex items-center">
                            <i class="fas fa-ethernet text-green-500 mr-2 w-4"></i>
                            <span class="font-medium">MAC:</span>
                        </span>
                        <span class="font-mono text-gray-800">{{ modulo.direccion_mac|default:"N/A" }}</span>
                    </div>

                    {% if modulo.memoria_libre or modulo.temperatura_interna or modulo.voltaje_alimentacion %}
                    <div class="border-t border-gray-300 my-2 pt-2">
                        {% if modulo.memoria_libre %}
                        <div class="flex items-center justify-between py-1">
                            <span class="flex items-center">
                                <i class="fas fa-memory text-indigo-500 mr-2 w-4"></i>
                                <span class="font-medium">Memoria Libre:</span>
                            </span>
                            <span class="font-mono text-gray-800">{{ modulo.memoria_libre|filesizeformat }}</span>
                        </div>
                        {% endif %}
                        
                        {% if modulo.temperatura_interna %}
                        <div class="flex items-center justify-between py-1">
                            <span class="flex items-center">
                                <i class="fas fa-fire text-orange-500 mr-2 w-4"></i>
                                <span class="font-medium">Temp. Interna:</span>
                            </span>
                            <span class="font-mono text-gray-800">{{ modulo.temperatura_interna|floatformat:1 }}°C</span>
                        </div>
                        {% endif %}
                        
                        {% if modulo.voltaje_alimentacion %}
                        <div class="flex items-center justify-between py-1">
                            <span class="flex items-center">
                                <i class="fas fa-bolt text-yellow-500 mr-2 w-4"></i>
                                <span class="font-medium">Voltaje:</span>
                            </span>
                            <span class="font-mono text-gray-800">{{ modulo.voltaje_alimentacion|floatformat:2 }}V</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- ===== FIN NUEVA SECCIÓN ===== -->
    </div>
    
    <!-- Footer con botones de acción -->
    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t">
        <a href="{% url 'modulo_detail' modulo.modulo_id %}" 
           class="text-xs text-blue-600 hover:text-blue-800 font-medium">
            <i class="fas fa-eye mr-1"></i>Ver detalles
        </a>
        
        <a href="{% url 'modulo_mediciones' modulo.modulo_id %}" 
           class="text-xs text-purple-600 hover:text-purple-800 font-medium">
            <i class="fas fa-chart-line mr-1"></i>Mediciones
        </a>
    </div>
</div>

<!-- Script para toggle de información técnica -->
<script>
function toggleInfoTecnica{{ modulo.modulo_id }}() {
    const panel = document.getElementById('info-tecnica-{{ modulo.modulo_id }}');
    panel.classList.toggle('hidden');
}

// Toggle información técnica
function toggleInfoTecnica{{ modulo.modulo_id }}() {
    const panel = document.getElementById('info-tecnica-{{ modulo.modulo_id }}');
    panel.classList.toggle('hidden');
}

// Función para reiniciar el módulo
function reiniciarModulo(moduloId) {
    const boton = document.getElementById(`btn-reinicio-${moduloId}`);
    const icono = document.getElementById(`icono-reinicio-${moduloId}`);
    const texto = document.getElementById(`texto-reinicio-${moduloId}`);
    const mensajeCooldown = document.getElementById(`mensaje-cooldown-${moduloId}`);
    const tiempoRestante = document.getElementById(`tiempo-restante-${moduloId}`);
    
    // Deshabilitar botón
    boton.disabled = true;
    icono.className = 'fas fa-spinner fa-spin';
    texto.textContent = 'Reiniciando...';
    
    // Hacer petición HTMX
    fetch(`/api/modulos/${moduloId}/reiniciar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            mostrarNotificacion('✅ Módulo reiniciado exitosamente', 'success');
            
            // Iniciar cooldown de 30 segundos
            let segundos = 30;
            tiempoRestante.textContent = segundos;
            mensajeCooldown.classList.remove('hidden');
            icono.className = 'fas fa-clock';
            texto.textContent = 'Esperando...';
            
            const intervalo = setInterval(() => {
                segundos--;
                tiempoRestante.textContent = segundos;
                
                if (segundos <= 0) {
                    clearInterval(intervalo);
                    boton.disabled = false;
                    icono.className = 'fas fa-redo-alt';
                    texto.textContent = 'Reiniciar Módulo';
                    mensajeCooldown.classList.add('hidden');
                }
            }, 1000);
        } else {
            // Mostrar mensaje de error
            mostrarNotificacion('❌ Error al reiniciar el módulo', 'error');
            boton.disabled = false;
            icono.className = 'fas fa-redo-alt';
            texto.textContent = 'Reiniciar Módulo';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('❌ Error de conexión', 'error');
        boton.disabled = false;
        icono.className = 'fas fa-redo-alt';
        texto.textContent = 'Reiniciar Módulo';
    });
}

// Función auxiliar para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar notificaciones (requiere que exista en tu base.html)
function mostrarNotificacion(mensaje, tipo) {
    // Puedes usar tu sistema de notificaciones existente
    // O simplemente un alert temporal
    const div = document.createElement('div');
    div.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg ${
        tipo === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white animate-fade-in`;
    div.textContent = mensaje;
    document.body.appendChild(div);
    
    setTimeout(() => {
        div.classList.add('animate-fade-out');
        setTimeout(() => div.remove(), 500);
    }, 3000);
}

</script>

<style>
/* Estilo para el indicador de estado */
.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 4px;
}

.status-indicator.online {
    background-color: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
}

.status-indicator.warning {
    background-color: #f59e0b;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
}

.status-indicator.offline {
    background-color: #ef4444;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
}
</style>